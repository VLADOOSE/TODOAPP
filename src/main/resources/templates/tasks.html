<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Todo App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div class="d-flex gap-2">
            <select id="statusFilter" class="form-select">
                <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                <option value="TODO">TODO</option>
                <option value="IN_PROGRESS">IN_PROGRESS</option>
                <option value="DONE">DONE</option>
            </select>

            <select id="sortBy" class="form-select">
                <option value="">–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞</option>
                <option value="dueDate">–°—Ä–æ–∫</option>
                <option value="status">–°—Ç–∞—Ç—É—Å</option>
            </select>

            <select id="order" class="form-select">
                <option value="asc">–ü–æ –≤–æ–∑—Ä–∞—Å—Ç–∞–Ω–∏—é</option>
                <option value="desc">–ü–æ —É–±—ã–≤–∞–Ω–∏—é</option>
            </select>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Todo App</h1>
        <div class="theme-toggle btn btn-outline-secondary" id="themeToggle">üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</div>
    </div>

    <div class="card mb-4">
        <div class="card-body">
            <form id="addTaskForm" class="row g-3">
                <div class="col-md-3"><input type="text" class="form-control" name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required></div>
                <div class="col-md-4"><input type="text" class="form-control" name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></div>
                <div class="col-md-2"><input type="date" class="form-control" name="dueDate" required></div>
                <div class="col-md-2">
                    <select class="form-control" name="status">
                        <option value="TODO">TODO</option>
                        <option value="IN_PROGRESS">IN_PROGRESS</option>
                        <option value="DONE">DONE</option>
                    </select>
                </div>
                <div class="col-md-1 d-grid">
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <table class="table table-striped table-hover" id="tasksTable">
        <thead>
        <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
            <th>–°—Ä–æ–∫</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
        </thead>
        <tbody id="tasksBody"></tbody>
    </table>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editTaskForm">
                <div class="modal-header">
                    <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editId">
                    <div class="mb-3"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="editTitle" class="form-control" required></div>
                    <div class="mb-3"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><input type="text" id="editDescription" class="form-control"></div>
                    <div class="mb-3"><label>–°—Ä–æ–∫</label><input type="date" id="editDueDate" class="form-control" required></div>
                    <div class="mb-3"><label>–°—Ç–∞—Ç—É—Å</label>
                        <select id="editStatus" class="form-control">
                            <option value="TODO">TODO</option>
                            <option value="IN_PROGRESS">IN_PROGRESS</option>
                            <option value="DONE">DONE</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const themeToggle = document.getElementById('themeToggle');

        const statusFilter = document.getElementById('statusFilter');
        const sortBy = document.getElementById('sortBy');
        const order = document.getElementById('order');

        const tasksBody = document.getElementById('tasksBody');
        const addForm = document.getElementById('addTaskForm');
        const editForm = document.getElementById('editTaskForm');
        const editModalEl = document.getElementById('editModal');
        const editModal = editModalEl ? new bootstrap.Modal(editModalEl) : null;

        const saved = localStorage.getItem('todo-theme');
        if (saved === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggle.textContent = 'üåû –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
        } else {
            document.body.classList.remove('dark-mode');
            themeToggle.textContent = 'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
        }
        themeToggle.addEventListener('click', () => {
            const dark = document.body.classList.toggle('dark-mode');
            themeToggle.textContent = dark ? 'üåû –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞' : 'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
            localStorage.setItem('todo-theme', dark ? 'dark' : 'light');
        });

        async function loadTasks(statusParam, sortParam, orderParam) {
            const statusVal = (typeof statusParam !== 'undefined') ? statusParam : (statusFilter ? statusFilter.value : '');
            const sortVal = (typeof sortParam !== 'undefined') ? sortParam : (sortBy ? sortBy.value : '');
            const orderVal = (typeof orderParam !== 'undefined') ? orderParam : (order ? order.value : '');

            const params = new URLSearchParams();
            if (statusVal) params.append('status', statusVal);
            if (sortVal) params.append('sortBy', sortVal);
            if (orderVal) params.append('order', orderVal);

            const url = params.toString() ? `/api/tasks?${params.toString()}` : '/api/tasks';

            console.log('[loadTasks] fetching', url);
            try {
                const res = await fetch(url);
                if (!res.ok) {
                    console.error('[loadTasks] fetch error', res.status, await res.text());
                    tasksBody.innerHTML = `<tr><td colspan="5" class="text-danger">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ${res.status}</td></tr>`;
                    return;
                }
                const tasks = await res.json();
                renderTasks(tasks);
            } catch (e) {
                console.error('[loadTasks] network/parse error', e);
                tasksBody.innerHTML = `<tr><td colspan="5" class="text-danger">–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞</td></tr>`;
            }
        }

        function renderTasks(tasks) {
            if (!Array.isArray(tasks) || tasks.length === 0) {
                tasksBody.innerHTML = `<tr><td colspan="5" class="text-muted">–ó–∞–¥–∞—á –Ω–µ –Ω–∞–π–¥–µ–Ω–æ</td></tr>`;
                return;
            }
            tasksBody.innerHTML = tasks.map(task => `
            <tr>
                <td>${escapeHtml(task.title)}</td>
                <td>${escapeHtml(task.description || '')}</td>
                <td>${task.dueDate || ''}</td>
                <td>${task.status || ''}</td>
                <td>
                    <button class="btn btn-warning btn-sm" onclick="editTask(${task.id})"><i class="bi bi-pencil"></i></button>
                    <button class="btn btn-danger btn-sm" onclick="deleteTask(${task.id})"><i class="bi bi-trash"></i></button>
                </td>
            </tr>
        `).join('');
        }

        function escapeHtml(text) {
            if (text == null) return '';
            return text
                .toString()
                .replaceAll('&', '&amp;')
                .replaceAll('<', '&lt;')
                .replaceAll('>', '&gt;')
                .replaceAll('"', '&quot;')
                .replaceAll("'", '&#039;');
        }

        [statusFilter, sortBy, order].forEach(el => {
            if (!el) return;
            el.addEventListener('change', () => loadTasks());
        });

        window.editTask = function(id) {
            fetch(`/api/tasks/${id}`)
                .then(res => {
                    if (!res.ok) throw new Error('fetch task failed ' + res.status);
                    return res.json();
                })
                .then(task => {
                    document.getElementById('editId').value = task.id;
                    document.getElementById('editTitle').value = task.title;
                    document.getElementById('editDescription').value = task.description;
                    document.getElementById('editDueDate').value = task.dueDate ? task.dueDate.split('T')[0] : '';
                    document.getElementById('editStatus').value = task.status;
                    editModal?.show();
                })
                .catch(err => {
                    console.error('editTask error', err);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –∑–∞–¥–∞—á—É');
                });
        };

        window.deleteTask = function(id) {
            if (!confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) return;
            fetch(`/api/tasks/${id}`, { method: 'DELETE' })
                .then(res => {
                    if (!res.ok) throw new Error('delete failed ' + res.status);
                    loadTasks();
                })
                .catch(err => {
                    console.error('deleteTask error', err);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —É–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É');
                });
        };


        if (addForm) {
            addForm.addEventListener('submit', e => {
                e.preventDefault();
                const data = Object.fromEntries(new FormData(addForm));
                fetch('/api/tasks', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(res => {
                    if (!res.ok) throw new Error('create failed ' + res.status);
                    addForm.reset();
                    loadTasks();
                }).catch(err => {
                    console.error('addForm error', err);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É');
                });
            });
        }

        if (editForm) {
            editForm.addEventListener('submit', e => {
                e.preventDefault();
                const id = document.getElementById('editId').value;
                const data = {
                    title: document.getElementById('editTitle').value,
                    description: document.getElementById('editDescription').value,
                    dueDate: document.getElementById('editDueDate').value,
                    status: document.getElementById('editStatus').value
                };
                fetch(`/api/tasks/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                }).then(res => {
                    if (!res.ok) throw new Error('update failed ' + res.status);
                    editModal?.hide();
                    loadTasks();
                }).catch(err => {
                    console.error('editForm error', err);
                    alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –∑–∞–¥–∞—á—É');
                });
            });
        }


        loadTasks();

    });
</script>
</body>
</html>
