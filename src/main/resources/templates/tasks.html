<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Todo App</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css" rel="stylesheet">
    <!-- –ü–û–î–ö–õ–Æ–ß–ê–ï–ú –≤–Ω–µ—à–Ω–∏–π css (–æ–±—Ä–∞—Ç–∏ –≤–Ω–∏–º–∞–Ω–∏–µ –Ω–∞ –ø—É—Ç—å) -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
<div class="container mt-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Todo App</h1>
        <div class="theme-toggle btn btn-outline-secondary" id="themeToggle">üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞</div>
    </div>

    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á–∏ -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="addTaskForm" class="row g-3">
                <div class="col-md-3"><input type="text" class="form-control" name="title" placeholder="–ù–∞–∑–≤–∞–Ω–∏–µ" required></div>
                <div class="col-md-4"><input type="text" class="form-control" name="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ"></div>
                <div class="col-md-2"><input type="date" class="form-control" name="dueDate" required></div>
                <div class="col-md-2">
                    <select class="form-control" name="status">
                        <option value="TODO">TODO</option>
                        <option value="IN_PROGRESS">IN_PROGRESS</option>
                        <option value="DONE">DONE</option>
                    </select>
                </div>
                <div class="col-md-1 d-grid">
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –∑–∞–¥–∞—á -->
    <table class="table table-striped table-hover" id="tasksTable">
        <thead>
        <tr>
            <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
            <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
            <th>–°—Ä–æ–∫</th>
            <th>–°—Ç–∞—Ç—É—Å</th>
            <th>–î–µ–π—Å—Ç–≤–∏—è</th>
        </tr>
        </thead>
        <tbody id="tasksBody"></tbody>
    </table>
</div>

<!-- –ú–æ–¥–∞–ª–∫–∞ (–∫–∞–∫ —É —Ç–µ–±—è) -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editTaskForm">
                <div class="modal-header">
                    <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∑–∞–¥–∞—á—É</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editId">
                    <div class="mb-3"><label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="editTitle" class="form-control" required></div>
                    <div class="mb-3"><label>–û–ø–∏—Å–∞–Ω–∏–µ</label><input type="text" id="editDescription" class="form-control"></div>
                    <div class="mb-3"><label>–°—Ä–æ–∫</label><input type="date" id="editDueDate" class="form-control" required></div>
                    <div class="mb-3"><label>–°—Ç–∞—Ç—É—Å</label>
                        <select id="editStatus" class="form-control">
                            <option value="TODO">TODO</option>
                            <option value="IN_PROGRESS">IN_PROGRESS</option>
                            <option value="DONE">DONE</option>
                        </select>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- JS –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', () => {
        // –∫–Ω–æ–ø–∫–∞ —Ç–µ–º—ã
        const themeToggle = document.getElementById('themeToggle');

        // –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ —Ç–µ–º—ã –∏–∑ localStorage
        const saved = localStorage.getItem('todo-theme');
        if (saved === 'dark') {
            document.body.classList.add('dark-mode');
            themeToggle.textContent = 'üåû –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞';
        } else {
            document.body.classList.remove('dark-mode');
            themeToggle.textContent = 'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
        }

        themeToggle.addEventListener('click', () => {
            const dark = document.body.classList.toggle('dark-mode');
            themeToggle.textContent = dark ? 'üåû –°–≤–µ—Ç–ª–∞—è —Ç–µ–º–∞' : 'üåô –¢—ë–º–Ω–∞—è —Ç–µ–º–∞';
            localStorage.setItem('todo-theme', dark ? 'dark' : 'light');
        });

        // –æ—Å—Ç–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –∑–∞–≥—Ä—É–∑–∫–∏/CRUD (–∫–∞–∫ —É —Ç–µ–±—è)
        const tasksBody = document.getElementById('tasksBody');
        const addForm = document.getElementById('addTaskForm');
        const editForm = document.getElementById('editTaskForm');
        const editModal = new bootstrap.Modal(document.getElementById('editModal'));

        function loadTasks() {
            fetch('/api/tasks')
                .then(res => res.json())
                .then(tasks => {
                    tasksBody.innerHTML = '';
                    tasks.forEach(task => {
                        tasksBody.innerHTML += `
                    <tr>
                        <td>${task.title}</td>
                        <td>${task.description}</td>
                        <td>${task.dueDate}</td>
                        <td>${task.status}</td>
                        <td>
                            <button class="btn btn-warning btn-sm" onclick="editTask(${task.id})"><i class="bi bi-pencil"></i></button>
                            <button class="btn btn-danger btn-sm" onclick="deleteTask(${task.id})"><i class="bi bi-trash"></i></button>
                        </td>
                    </tr>`;
                    });
                });
        }

        window.editTask = function(id) {
            fetch(`/api/tasks/${id}`)
                .then(res => res.json())
                .then(task => {
                    document.getElementById('editId').value = task.id;
                    document.getElementById('editTitle').value = task.title;
                    document.getElementById('editDescription').value = task.description;
                    document.getElementById('editDueDate').value = task.dueDate;
                    document.getElementById('editStatus').value = task.status;
                    editModal.show();
                });
        };

        window.deleteTask = function(id) {
            if (confirm('–£–¥–∞–ª–∏—Ç—å –∑–∞–¥–∞—á—É?')) {
                fetch(`/api/tasks/${id}`, { method: 'DELETE' }).then(() => loadTasks());
            }
        };

        addForm.addEventListener('submit', e => {
            e.preventDefault();
            const data = Object.fromEntries(new FormData(addForm));
            fetch('/api/tasks', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
                .then(() => { addForm.reset(); loadTasks(); });
        });

        editForm.addEventListener('submit', e => {
            e.preventDefault();
            const id = document.getElementById('editId').value;
            const data = {
                title: document.getElementById('editTitle').value,
                description: document.getElementById('editDescription').value,
                dueDate: document.getElementById('editDueDate').value,
                status: document.getElementById('editStatus').value
            };
            fetch(`/api/tasks/${id}`, { method: 'PUT', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(data) })
                .then(() => { editModal.hide(); loadTasks(); });
        });

        loadTasks();
    }); // DOMContentLoaded end
</script>
</body>
</html>
